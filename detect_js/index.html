<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Hello OpenCV.js</title>
    <style>
        .inputoutput img,
        .inputoutput canvas {
            max-width: 100%;
            /* Makes image and canvas not exceed the width of their container */
            max-height: 400px;
            /* Adjust this value based on your page layout */
            display: block;
            /* Ensures max-width and max-height are respected */
            margin: 0 auto;
            /* Centers the image/canvas if it's smaller than the max width */
        }
    </style>
    <script async src="opencv.js" type="text/javascript"></script>
</head>

<body>
    <h2>Hello OpenCV.js</h2>
    <p id="status">OpenCV.js is loading...</p>
    <button onclick="runDiceDetection()">Run Dice Detection</button>
    <div>
        <p id="timeTaken"></p>
        <div class="inputoutput">
            <img id="imageSrc" alt="No Image" src="../examples/far_full.jpg" />
            <div class="caption">imageSrc <input type="file" id="fileInput" name="file" /></div>
        </div>
        <div class="inputoutput">
            <canvas id="hsvOutput"></canvas>
            <div class="caption">hsvOutput</div>
        </div>
        <div class="inputoutput">
            <canvas id="hsvBlackOutput"></canvas>
            <div class="caption">hsvBlackOutput</div>
        </div>
        <div class="inputoutput">
            <canvas id="hsvYellowOutput"></canvas>
            <div class="caption">hsvYellowOutput</div>
        </div>
        <div class="inputoutput">
            <canvas id="hsvRedOutput"></canvas>
            <div class="caption">hsvRedOutput</div>
        </div>
        <div class="inputoutput">
            <canvas id="hsvPurpleOutput"></canvas>
            <div class="caption">hsvPurpleOutput</div>
        </div>
        <div class="inputoutput">
            <canvas id="hsvBlueOutput"></canvas>
            <div class="caption">hsvBlueOutput</div>
        </div>
        <div class="inputoutput">
            <canvas id="hsvGreenOutput"></canvas>
            <div class="caption">hsvGreenOutput</div>
        </div>
        <div class="inputoutput">
            <canvas id="hsvBlackOpened"></canvas>
            <div class="caption">hsvBlackOpened</div>
        </div>
        <div class="inputoutput">
            <canvas id="canvasOutput"></canvas>
            <div class="caption">canvasOutput</div>
        </div>
    </div>
    <script type="text/javascript">
        function getBlackMask(hsv) {
            // Threshold the HSV image to get only black colors 
            let hsvBlack = new cv.Mat();
            let low = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [0, 0, 0, 0]);
            let high = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [180, 255, 50, 0]);
            cv.inRange(hsv, low, high, hsvBlack);
            return hsvBlack;
        }

        function getYellowMask(hsv) {
            // Threshold the HSV image to get only yellow colors 
            let hsvYellow = new cv.Mat();
            let low = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [180 * 0.085, 255 * 0.220, 255 * 0.204, 0]);
            let high = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [180 * 0.247, 255, 255, 0]);
            cv.inRange(hsv, low, high, hsvYellow);
            return hsvYellow;
        }

        function getRedMask(hsv) {
            // Threshold the HSV image to get only red colors 
            let hsvRed = new cv.Mat();
            // Hue range for red is 0-15 and 165-180, since red is wrap around
            let low1 = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [180 * 0.914, 255 * 0.220, 255 * 0.204, 0]);
            let high1 = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [180, 255, 255, 0]);
            cv.inRange(hsv, low1, high1, hsvRed);

            let mat2 = new cv.Mat();
            let low2 = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [0, 255 * 0.220, 255 * 0.204, 0]);
            let high2 = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [180 * 0.075, 255, 255, 0]);
            cv.inRange(hsv, low2, high2, mat2);

            cv.bitwise_or(hsvRed, mat2, hsvRed);
            mat2.delete();

            return hsvRed;
        }

        function getPurpleMask(hsv) {
            // Threshold the HSV image to get only purple colors 
            let hsvPurple = new cv.Mat();
            let low = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [180 * 0.711, 255 * 0.171, 255 * 0.123, 0]);
            let high = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [180 * 0.902, 255, 255, 0]);
            cv.inRange(hsv, low, high, hsvPurple);
            return hsvPurple;
        }

        function getBlueMask(hsv) {
            // Threshold the HSV image to get only blue colors 
            let hsvBlue = new cv.Mat();
            let low = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [180 * 0.527, 255 * 0.327, 255 * 0.236, 0]);
            let high = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [180 * 0.684, 255, 255, 0]);
            cv.inRange(hsv, low, high, hsvBlue);
            return hsvBlue;
        }

        function getGreenMask(hsv) {
            // Threshold the HSV image to get only green colors 
            let hsvGreen = new cv.Mat();
            let low = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [180 * 0.354, 255 * 0.109, 255 * 0.07, 0]);
            let high = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [180 * 0.497, 255, 255, 0]);
            cv.inRange(hsv, low, high, hsvGreen);
            return hsvGreen;
        }

        function runDiceDetection() {
            var startTime = performance.now();

            let src = cv.imread('imageSrc');
            // Find edges using Hough Transform
            let dst = cv.Mat.zeros(src.rows, src.cols, cv.CV_8UC3);

            // Convert image to HSV
            let hsv = cv.Mat.zeros(src.rows, src.cols, cv.CV_8UC3);
            cv.cvtColor(src, hsv, cv.COLOR_RGB2HSV, 0);
            cv.imshow('hsvOutput', hsv);

            // Threshold the HSV image to get only black colors 
            let hsvBlack = getBlackMask(hsv);
            cv.imshow('hsvBlackOutput', hsvBlack);

            // Threshold the HSV image to get only yellow colors
            let hsvYellow = getYellowMask(hsv);
            cv.imshow('hsvYellowOutput', hsvYellow);

            // Threshold the HSV image to get only red colors
            let hsvRed = getRedMask(hsv);
            cv.imshow('hsvRedOutput', hsvRed);

            // Threshold the HSV image to get only purple colors
            let hsvPurple = getPurpleMask(hsv);
            cv.imshow('hsvPurpleOutput', hsvPurple);

            // Threshold the HSV image to get only blue colors
            let hsvBlue = getBlueMask(hsv);
            cv.imshow('hsvBlueOutput', hsvBlue);

            // Threshold the HSV image to get only green colors
            let hsvGreen = getGreenMask(hsv);
            cv.imshow('hsvGreenOutput', hsvGreen);

            // Mask opening
            let kernel = cv.Mat.ones(3, 3, cv.CV_8U);
            let anchor = new cv.Point(-1, -1);
            let iterations = 1;
            let hsvBlackOpened = new cv.Mat();
            cv.morphologyEx(hsvBlack, hsvBlackOpened, cv.MORPH_OPEN, kernel, anchor, iterations);
            cv.imshow('hsvBlackOpened', hsvBlackOpened);

            let lines = new cv.Mat();
            let color = new cv.Scalar(255, 0, 0);
            // cv.cvtColor(hsv, src, cv.COLOR_RGBA2GRAY, 0);
            cv.Canny(hsvBlackOpened, hsvBlackOpened, 220, 250, 5);
            // You can try more different parameters
            cv.HoughLinesP(hsvBlackOpened, lines, 1, Math.PI / 180, 2, 0, 0);
            // draw lines
            for (let i = 0; i < lines.rows; ++i) {
                let startPoint = new cv.Point(lines.data32S[i * 4], lines.data32S[i * 4 + 1]);
                let endPoint = new cv.Point(lines.data32S[i * 4 + 2], lines.data32S[i * 4 + 3]);
                cv.line(dst, startPoint, endPoint, color);
            }
            cv.imshow('canvasOutput', dst);
            // Dispose the mats to free memory
            src.delete(); hsv.delete(); hsvBlackOpened.delete(); dst.delete(); lines.delete();
            hsvBlack.delete();
            hsvYellow.delete();
            hsvRed.delete();
            hsvPurple.delete();
            hsvBlue.delete();
            hsvGreen.delete();

            var endTime = performance.now();
            var timeTaken = endTime - startTime;
            document.getElementById('timeTaken').innerHTML = 'Time taken: ' + timeTaken + 'ms';
        }

        let imgElement = document.getElementById('imageSrc');
        let inputElement = document.getElementById('fileInput');
        inputElement.addEventListener('change', (e) => {
            imgElement.src = URL.createObjectURL(e.target.files[0]);
        }, false);

        var Module = {
            // https://emscripten.org/docs/api_reference/module.html#Module.onRuntimeInitialized
            onRuntimeInitialized() {
                document.getElementById('status').innerHTML = 'OpenCV.js is ready.';
                imgElement.onload = runDiceDetection;
            }
        };
    </script>


</body>

</html>